module mac(
input clk,
input [15:0] w_in [63:0],
input [15:0] d_in [63:0],
input [15:0] bias,
output [15:0] acc_out
);

reg state = 0;
reg nextstate = 0;
reg [15:0] psum =0;

wire[15:0] y00;
wire[15:0] y01;
wire[15:0] y02;
wire[15:0] y03;
wire[15:0] y04;
wire[15:0] y05;
wire[15:0] y06;
wire[15:0] y07;
wire[15:0] y08;
wire[15:0] y09;
wire[15:0] y10;
wire[15:0] y11;
wire[15:0] y12;
wire[15:0] y13;
wire[15:0] y14;
wire[15:0] y15;
wire[15:0] y16;
wire[15:0] y17;
wire[15:0] y18;
wire[15:0] y19;
wire[15:0] y20;
wire[15:0] y21;
wire[15:0] y22;
wire[15:0] y23;
wire[15:0] y24;
wire[15:0] y25;
wire[15:0] y26;
wire[15:0] y27;
wire[15:0] y28;
wire[15:0] y29;
wire[15:0] y30;
wire[15:0] y31;
wire[15:0] y32;
wire[15:0] y33;
wire[15:0] y34;
wire[15:0] y35;
wire[15:0] y36;
wire[15:0] y37;
wire[15:0] y38;
wire[15:0] y39;
wire[15:0] y40;
wire[15:0] y41;
wire[15:0] y42;
wire[15:0] y43;
wire[15:0] y44;
wire[15:0] y45;
wire[15:0] y46;
wire[15:0] y47;
wire[15:0] y48;
wire[15:0] y49;
wire[15:0] y50;
wire[15:0] y51;
wire[15:0] y52;
wire[15:0] y53;
wire[15:0] y54;
wire[15:0] y55;
wire[15:0] y56;
wire[15:0] y57;
wire[15:0] y58;
wire[15:0] y59;
wire[15:0] y60;
wire[15:0] y61;
wire[15:0] y62;
wire[15:0] y63;

wire [15:0] z01;
wire [15:0] z02;
wire [15:0] z03;
wire [15:0] z04;
wire [15:0] z05;
wire [15:0] z06;
wire [15:0] z07;
wire [15:0] z08;
wire [15:0] z09;
wire [15:0] z10;
wire [15:0] z11;
wire [15:0] z12;
wire [15:0] z13;
wire [15:0] z14;
wire [15:0] z15;
wire [15:0] z16;
wire [15:0] z17;
wire [15:0] z18;
wire [15:0] z19;
wire [15:0] z20;
wire [15:0] z21;
wire [15:0] z22;
wire [15:0] z23;
wire [15:0] z24;
wire [15:0] z25;
wire [15:0] z26;
wire [15:0] z27;
wire [15:0] z28;
wire [15:0] z29;
wire [15:0] z30;
wire [15:0] z31;
wire [15:0] z32;


wire [15:0] k01;
wire [15:0] k02;
wire [15:0] k03;
wire [15:0] k04;
wire [15:0] k05;
wire [15:0] k06;
wire [15:0] k07;
wire [15:0] k08;
wire [15:0] k09;
wire [15:0] k10;
wire [15:0] k11;
wire [15:0] k12;
wire [15:0] k13;
wire [15:0] k14;
wire [15:0] k15;
wire [15:0] k16;

wire [15:0] j01;
wire [15:0] j02;
wire [15:0] j03;
wire [15:0] j04;
wire [15:0] j05;
wire [15:0] j06;
wire [15:0] j07;
wire [15:0] j08;

wire [15:0] m01;
wire [15:0] m02;
wire [15:0] m03;
wire [15:0] m04;

wire [15:0] n01;
wire [15:0] n02;




always @(state) begin

	case(state)
	0:Layer0
	mul_dsp M_00(.clk(clk), W(w_in[0]), X(d_in[0], Y(y00));
	mul_dsp M_01(.clk(clk), W(w_in[1]), X(d_in[1], Y(y01));
	mul_dsp M_02(.clk(clk), W(w_in[2]), X(d_in[2], Y(y02));
	mul_dsp M_03(.clk(clk), W(w_in[3]), X(d_in[3], Y(y03));
	mul_dsp M_04(.clk(clk), W(w_in[4]), X(d_in[4], Y(y04));
	mul_dsp M_05(.clk(clk), W(w_in[5]), X(d_in[5], Y(y05));
	mul_dsp M_06(.clk(clk), W(w_in[6]), X(d_in[6], Y(y06));
	mul_dsp M_07(.clk(clk), W(w_in[7]), X(d_in[7], Y(y07));
	mul_dsp M_08(.clk(clk), W(w_in[8]), X(d_in[8], Y(y08));
	mul_dsp M_09(.clk(clk), W(w_in[9]), X(d_in[9], Y(y09));
	mul_dsp M_10(.clk(clk), W(w_in[10]), X(d_in[10], Y(y10));
	mul_dsp M_11(.clk(clk), W(w_in[11]), X(d_in[11], Y(y11));
	mul_dsp M_12(.clk(clk), W(w_in[12]), X(d_in[12], Y(y12));
	mul_dsp M_13(.clk(clk), W(w_in[13]), X(d_in[13]), Y(y13));
	mul_dsp M_14(.clk(clk), W(w_in[14]), X(d_in[14]), Y(y14));
	mul_dsp M_15(.clk(clk), W(w_in[15]), X(d_in[15]), Y(y15));
	mul_dsp M_16(.clk(clk), W(w_in[16]), X(d_in[16]), Y(y16));
	mul_dsp M_17(.clk(clk), W(w_in[17]), X(d_in[17]), Y(y17));
	mul_dsp M_18(.clk(clk), W(w_in[18]), X(d_in[18]), Y(y18));
	mul_dsp M_19(.clk(clk), W(w_in[19]), X(d_in[19]), Y(y19));
	mul_dsp M_20(.clk(clk), W(w_in[20]), X(d_in[20]), Y(y20));
	mul_dsp M_21(.clk(clk), W(w_in[21]), X(d_in[21]), Y(y21));
	mul_dsp M_22(.clk(clk), W(w_in[22]), X(d_in[22]), Y(y22));
	mul_dsp M_23(.clk(clk), W(w_in[23]), X(d_in[23]), Y(y23));
	mul_dsp M_24(.clk(clk), W(w_in[24]), X(d_in[24]), Y(y24));
	mul_dsp M_25(.clk(clk), W(w_in[25]), X(d_in[25]), Y(y25));
	mul_dsp M_26(.clk(clk), W(w_in[26]), X(d_in[26]), Y(y26));
	mul_dsp M_27(.clk(clk), W(w_in[27]), X(d_in[27]), Y(y27));
	mul_dsp M_28(.clk(clk), W(w_in[28]), X(d_in[28]), Y(y28));
	mul_dsp M_29(.clk(clk), W(w_in[29]), X(d_in[29]), Y(y29));
	mul_dsp M_30(.clk(clk), W(w_in[30]), X(d_in[30]), Y(y30));
	mul_dsp M_31(.clk(clk), W(w_in[31]), X(d_in[31]), Y(y31));
	mul_dsp M_32(.clk(clk), W(w_in[32]), X(d_in[32]), Y(y32));
	mul_dsp M_33(.clk(clk), W(w_in[33]), X(d_in[33]), Y(y33));
	mul_dsp M_34(.clk(clk), W(w_in[34]), X(d_in[34]), Y(y34));
	mul_dsp M_35(.clk(clk), W(w_in[35]), X(d_in[35]), Y(y35));
	mul_dsp M_36(.clk(clk), W(w_in[36]), X(d_in[36]), Y(y36));
	mul_dsp M_37(.clk(clk), W(w_in[37]), X(d_in[37]), Y(y37));
	mul_dsp M_38(.clk(clk), W(w_in[38]), X(d_in[38]), Y(y38));
	mul_dsp M_39(.clk(clk), W(w_in[39]), X(d_in[39]), Y(y39));
	mul_dsp M_40(.clk(clk), W(w_in[40]), X(d_in[40]), Y(y40));
	mul_dsp M_41(.clk(clk), W(w_in[41]), X(d_in[41]), Y(y41));
	mul_dsp M_42(.clk(clk), W(w_in[42]), X(d_in[42]), Y(y42));
	mul_dsp M_43(.clk(clk), W(w_in[43]), X(d_in[43]), Y(y43));
	mul_dsp M_44(.clk(clk), W(w_in[44]), X(d_in[44]), Y(y44));
	mul_dsp M_45(.clk(clk), W(w_in[45]), X(d_in[45]), Y(y45));
	mul_dsp M_46(.clk(clk), W(w_in[46]), X(d_in[46]), Y(y46));
	mul_dsp M_47(.clk(clk), W(w_in[47]), X(d_in[47]), Y(y47));
	mul_dsp M_48(.clk(clk), W(w_in[48]), X(d_in[48]), Y(y48));
	mul_dsp M_49(.clk(clk), W(w_in[49]), X(d_in[49]), Y(y49));
	mul_dsp M_50(.clk(clk), W(w_in[50]), X(d_in[50]), Y(y50));
	mul_dsp M_51(.clk(clk), W(w_in[51]), X(d_in[51]), Y(y51));
	mul_dsp M_52(.clk(clk), W(w_in[52]), X(d_in[52]), Y(y52));
	mul_dsp M_53(.clk(clk), W(w_in[53]), X(d_in[53]), Y(y53));
	mul_dsp M_54(.clk(clk), W(w_in[54]), X(d_in[54]), Y(y54));
	mul_dsp M_55(.clk(clk), W(w_in[55]), X(d_in[55]), Y(y55));
	mul_dsp M_56(.clk(clk), W(w_in[56]), X(d_in[56]), Y(y56));
	mul_dsp M_57(.clk(clk), W(w_in[57]), X(d_in[57]), Y(y57));
	mul_dsp M_58(.clk(clk), W(w_in[58]), X(d_in[58]), Y(y58));
	mul_dsp M_59(.clk(clk), W(w_in[59]), X(d_in[59]), Y(y59));
	mul_dsp M_60(.clk(clk), W(w_in[60]), X(d_in[60]), Y(y60));
	mul_dsp M_61(.clk(clk), W(w_in[61]), X(d_in[61]), Y(y61));
	mul_dsp M_62(.clk(clk), W(w_in[62]), X(d_in[62]), Y(y62));
	mul_dsp M_63(.clk(clk), W(w_in[63]), X(d_in[63]), Y(y63));
	nextstate=1;

	1:Layer1
	adder_dsp A_00(.clk(clk), W(y00), X(y01), Y(z01));
	adder_dsp A_01(.clk(clk), W(y02), X(y03), Y(z02));
	adder_dsp A_02(.clk(clk), W(y04), X(y05), Y(z03));
	adder_dsp A_03(.clk(clk), W(y06), X(y07), Y(z04));
	adder_dsp A_04(.clk(clk), W(y08), X(y09), Y(z05));
	adder_dsp A_05(.clk(clk), W(y10), X(y11), Y(z06));
	adder_dsp A_06(.clk(clk), W(y12), X(y13), Y(z07));
	adder_dsp A_07(.clk(clk), W(y14), X(y15), Y(z08));
	adder_dsp A_08(.clk(clk), W(y16), X(y17), Y(z09));
	adder_dsp A_09(.clk(clk), W(y18), X(y19), Y(z10));
	adder_dsp A_10(.clk(clk), W(y20), X(y21), Y(z11));
	adder_dsp A_11(.clk(clk), W(y22), X(y23), Y(z12));
	adder_dsp A_12(.clk(clk), W(y24), X(y25), Y(z13));
	adder_dsp A_13(.clk(clk), W(y26), X(y27), Y(z14));
	adder_dsp A_14(.clk(clk), W(y28), X(y29), Y(z15));
	adder_dsp A_15(.clk(clk), W(y30), X(y31), Y(z16));
	adder_dsp A_16(.clk(clk), W(y32), X(y33), Y(z17));
	adder_dsp A_17(.clk(clk), W(y34), X(y35), Y(z18));
	adder_dsp A_18(.clk(clk), W(y36), X(y37), Y(z19));
	adder_dsp A_19(.clk(clk), W(y38), X(y39), Y(z20));
	adder_dsp A_20(.clk(clk), W(y40), X(y41), Y(z21));
	adder_dsp A_21(.clk(clk), W(y42), X(y43), Y(z22));
	adder_dsp A_22(.clk(clk), W(y44), X(y45), Y(z23));
	adder_dsp A_23(.clk(clk), W(y46), X(y47), Y(z24));
	adder_dsp A_24(.clk(clk), W(y48), X(y49), Y(z25));
	adder_dsp A_25(.clk(clk), W(y50), X(y51), Y(z26));
	adder_dsp A_26(.clk(clk), W(y52), X(y53), Y(z27));
	adder_dsp A_27(.clk(clk), W(y54), X(y55), Y(z28));
	adder_dsp A_28(.clk(clk), W(y56), X(y57), Y(z29));
	adder_dsp A_29(.clk(clk), W(y58), X(y59), Y(z30));
	adder_dsp A_30(.clk(clk), W(y60), X(y61), Y(z31));
	adder_dsp A_31(.clk(clk), W(y62), X(y63), Y(z32));
	nextstate=2;
	2:Layer2
	adder_dsp B_00(.clk(clk), W(z00), X(z01), Y(k01));
	adder_dsp B_01(.clk(clk), W(z02), X(z03), Y(k02));
	adder_dsp B_02(.clk(clk), W(z04), X(z05), Y(k03));
	adder_dsp B_03(.clk(clk), W(z06), X(z07), Y(k04));
	adder_dsp B_04(.clk(clk), W(z08), X(z09), Y(k05));
	adder_dsp B_05(.clk(clk), W(z10), X(z11), Y(k06));
	adder_dsp B_06(.clk(clk), W(z12), X(z13), Y(k07));
	adder_dsp B_07(.clk(clk), W(z14), X(z15), Y(k08));
	adder_dsp B_08(.clk(clk), W(z16), X(z17), Y(k09));
	adder_dsp B_09(.clk(clk), W(z18), X(z19), Y(k10));
	adder_dsp B_10(.clk(clk), W(z20), X(z21), Y(k11));
	adder_dsp B_11(.clk(clk), W(z22), X(z23), Y(k12));
	adder_dsp B_12(.clk(clk), W(z24), X(z25), Y(k13));
	adder_dsp B_13(.clk(clk), W(z26), X(z27), Y(k14));
	adder_dsp B_14(.clk(clk), W(z28), X(z29), Y(k15));
	adder_dsp B_15(.clk(clk), W(z30), X(z31), Y(k16));
	nextstate=3;
	3:Layer3
	adder_dsp C_00(.clk(clk), W(k00), X(k01), Y(j01));
	adder_dsp C_01(.clk(clk), W(k02), X(k03), Y(j02));
	adder_dsp C_02(.clk(clk), W(k04), X(k05), Y(j03));
	adder_dsp C_03(.clk(clk), W(k06), X(k07), Y(j04));
	adder_dsp C_04(.clk(clk), W(k08), X(k09), Y(j05));
	adder_dsp C_05(.clk(clk), W(k10), X(k11), Y(j06));
	adder_dsp C_06(.clk(clk), W(k12), X(k13), Y(j07));
	nextstate=4;
	4:Layer4
	adder_dsp D_00(.clk(clk), W(j00), X(j01), Y(m01));
	adder_dsp D_01(.clk(clk), W(j02), X(j03), Y(m02));
	adder_dsp D_02(.clk(clk), W(j04), X(j05), Y(m03));
	adder_dsp D_03(.clk(clk), W(j06), X(j07), Y(m04));
	nextstate=5;
	5:Layer5
	adder_dsp E_00(.clk(clk), W(m00), X(m01), Y(n01));
	adder_dsp E_01(.clk(clk), W(m02), X(m03), Y(n02));
	nextstate=6;
	6:Layer6
	adder_dsp F_00(.clk(clk), W(n00), X(n01), Y(psum));
	#20 adder_dsp F_01(.clk(clk), W(psum), X(bias), Y(acc_out));
	end

// 여기다가 초기화 코드 넣을 수도 있음 베릴로그 270참고
always @(podsge clock) begin
	state <= nextstate;
end

endmodule
